<?php defined('SYSPATH') or die('No direct script access.');  class Controller_Dashboard extends Controller_Layout {  	public function before(){		 parent::before();	     $this->template->set_filename('layout/admin');	}  	public function __construct(Request $request)	{                        // Check Login or not               if (Auth::instance()->logged_in('',$all_required=false) == 0) {                             Request::current()->redirect('/auth/signin');                }            		// Assign the request to the controller    		parent::__construct($request);	}		public function action_index()	{		$obj_dashboard = new Model_Dashboard();        $logged_in_userid = Auth::instance()->get_user()->id;		$objLeads = ORM::factory('leads');			          			if($_POST){					if($_POST['search_startdate']!='')				$startdate =  date('Y-m-d',strtotime($_POST['search_startdate']))." 00:00:00";			if($_POST['search_enddate']=='')				$enddate = date('Y-m-d h:i:s');			else				$enddate =  date('Y-m-d',strtotime($_POST['search_enddate']))." 00:00:00";					/*************** TOTAL Lead **********************/						$total_lead = $objLeads->select(DB::expr('count(lead_id) as total_lead'));			$total_lead = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead = $objLeads->where('lead_campaign','=','Auto');						if($startdate!='')						$total_lead = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead = $objLeads->find_all()->as_array();						/*************** TOTAL Lead Price **********************/						$total_lead_price = $objLeads->select(DB::expr('sum(lead_amount) as total_lead_price'));			$total_lead_price = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead_price = $objLeads->where('lead_campaign','=','Auto');						if($startdate!='')						$total_lead_price = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead_price = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead_price = $objLeads->find_all()->as_array();						/*************** TOTAL Lead Return **********************/						$total_lead_return = $objLeads->select(DB::expr('count(lead_id) as total_lead_return'));			$total_lead_return = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead_return = $objLeads->where('lead_type','=','return');			$total_lead_return = $objLeads->where('lead_campaign','=','Auto');						if($startdate!='')						$total_lead_return = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead_return = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead_return = $objLeads->find_all()->as_array();						/*************** TOTAL Lead Return Price**********************/						$total_lead_return_price = $objLeads->select(DB::expr('sum(lead_amount) as total_lead_return_price'));			$total_lead_return_price = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead_return_price = $objLeads->where('lead_type','=','return');			$total_lead_return_price = $objLeads->where('lead_campaign','=','Auto');						if($startdate!='')						$total_lead_return_price = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead_return_price = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead_return_price = $objLeads->find_all()->as_array();						//echo Database::instance()->last_query;											$total_lead_price=$total_lead_price[0]->total_lead_price;			$total_lead_return_price=$total_lead_return_price[0]->total_lead_return_price;			$total_lead_return=$total_lead_return[0]->total_lead_return;			$total_lead=$total_lead[0]->total_lead;						/*************** TOTAL Lead Payday**********************/						$total_lead_payday = $objLeads->select(DB::expr('count(lead_id) as total_lead_payday'));			$total_lead_payday = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead_payday = $objLeads->where('lead_campaign','=','Payday');						if($startdate!='')						$total_lead_payday = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead_payday = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead_payday = $objLeads->find_all()->as_array();						/*************** TOTAL Lead Price **********************/						$total_lead_price_payday = $objLeads->select(DB::expr('sum(lead_amount) as total_lead_price_payday'));			$total_lead_price_payday = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead_price_payday = $objLeads->where('lead_campaign','=','Payday');						if($startdate!='')						$total_lead_price_payday = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead_price_payday = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead_price_payday = $objLeads->find_all()->as_array();						/*************** TOTAL Lead Return **********************/						$total_lead_return_payday = $objLeads->select(DB::expr('count(lead_id) as total_lead_return_payday'));			$total_lead_return_payday = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead_return_payday = $objLeads->where('lead_type','=','return');			$total_lead_return_payday = $objLeads->where('lead_campaign','=','Payday');									if($startdate!='')						$total_lead_return_payday = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead_return_payday = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead_return_payday = $objLeads->find_all()->as_array();						/*************** TOTAL Lead Return Price**********************/						$total_lead_return_price_payday = $objLeads->select(DB::expr('sum(lead_amount) as total_lead_return_price_payday'));			$total_lead_return_price_payday = $objLeads->where('user_id','=',$logged_in_userid);			$total_lead_return_price_payday = $objLeads->where('lead_type','=','return');			$total_lead_return_price_payday = $objLeads->where('lead_campaign','=','Payday');						if($startdate!='')						$total_lead_return_price_payday = $objLeads->where('tbl_leads.sold_date','>=',$startdate);			if($enddate!='')						$total_lead_return_price_payday = $objLeads->where('tbl_leads.sold_date','<=',$enddate);									$total_lead_return_price_payday = $objLeads->find_all()->as_array();						//echo Database::instance()->last_query;											$total_lead_price_payday=$total_lead_price_payday[0]->total_lead_price_payday;			$total_lead_return_price_payday=$total_lead_return_price_payday[0]->total_lead_return_price_payday;			$total_lead_return_payday=$total_lead_return_payday[0]->total_lead_return_payday;			$total_lead_payday=$total_lead_payday[0]->total_lead_payday;											}		else		{			$total_lead_price=0;			$total_lead_return_price=0;			$total_lead_return=0;			$total_lead=0;		}			                   //$this->createGraph();           		$this->template->title = "Dashboard";		$this->template->content = View::factory('dashboard/index')  			 ->set('dash_datas', $dash_datas)			 ->set('total_lead_price',  $total_lead_price)			 ->set('total_lead_return_price', $total_lead_return_price)			 ->set('total_lead_return', $total_lead_return)			 ->set('total_leads', $total_lead)			 ->set('total_lead_price_payday',  $total_lead_price_payday)			 ->set('total_lead_return_price_payday', $total_lead_return_price_payday)			 ->set('total_lead_return_payday', $total_lead_return_payday)			 ->set('total_leads_payday', $total_lead_payday);                                                   	}	public function action_indexr()	{                        $obj_dashboard = new Model_Dashboard();            $logged_in_userid = Auth::instance()->get_user()->id;  		$this->template->title = "Dashboard";		$this->template->content = View::factory('dashboard/index_real')  			->set('dash_datas', $dash_datas)                        ->set('money_coming', $money_coming)                        ->set('newest_members_lists', $newest_members_lists);                        	}                public function createGraph()        {                                    //$AutoData ='30';// Delete this once online                                   $file_string='{                    "graphset":[                            {                                "type":"pie",                                "alpha":1,                                "background-color":"#2A2325",                                "title":{                                    "text":"Total Leads",                                    "font-family":"helvetica",                                    "font-size":"20px",                                    "font-weight":"bold",                                    "background-color":"#2A2325",                                    "margin-top":"15px",                                    "margin-left":"45px",                                    "margin-bottom":"10px",                                    "text-align":"left"                                },                                "legend":{                                    "layout":"2x2",                                    "position":"95% 0%",                                    "width":"175px",                                    "height":"45px",                                    "visible":true,                                    "border-radius":"5px",                                    "font-family":"helvetica",                                    "font-size":"10px",                                    "background-color":"#2A2325",                                    "border-width":"1px",                                    "border-color":"#808080",                                    "item":{                                        "font-color":"#fff",                                        "marker-style":"circle",                                        "padding":"-2 2",                                        "border-width":"0px"                                    }                                },                                "tooltip":{                                    "visible":true,                                    "font-color":"#000000"                                },                                "plot":{                                    "offset":"5",                                    "tooltip-text":"%v  %t",                                    "detach":true,                                    "border-color":"#2A2325",                                    "value-box":{                                        "placement":"in",                                        "connected":false,                                        "font-color":"#000000"                                    }                                },                                "series":[                                    {                                        "values":['.$AutoData.'],                                        "background-color":"#8DD62E",                                        "text":"Auto"                                    },                                    {                                        "values":['.$paydayData.'],                                        "background-color":"#FF006F",                                        "text":"Payday"                                    },                                    {                                        "values":['.$NewcarData.'],                                        "background-color":"#00D3E6",                                        "text":"NewCar"                                    },                                    {                                        "values":['.$NewpaydayData.'],                                        "background-color":"#FFD540",                                        "text":"New Payday"                                    }                                ]                            }                        ]                        }';            $myFile_ping_response = "chart/Leads_Client.txt";            $fh = fopen($myFile_ping_response, 'w') or die("can't open file");            fwrite($fh, $file_string);            fclose($fh);        }} // End Dashboard